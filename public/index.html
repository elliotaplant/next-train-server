<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextTrain</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/favicon.ico">
    <meta name="theme-color" content="#007AFF">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f2f2f7;
            color: #1c1c1e;
            line-height: 1.5;
        }
        
        .header {
            background-color: #fff;
            padding: 15px 20px;
            border-bottom: 1px solid #e5e5ea;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #0051d5;
        }
        
        .btn:disabled {
            background-color: #c7c7cc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #e5e5ea;
            color: #1c1c1e;
        }
        
        .btn-secondary:hover {
            background-color: #d1d1d6;
        }
        
        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .favorite-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .favorite-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .favorite-info h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
        
        .favorite-info p {
            font-size: 14px;
            color: #8e8e93;
        }
        
        .agency-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            object-fit: contain;
        }
        
        .remove-btn {
            background-color: #ff3b30;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .remove-btn:hover {
            background-color: #d70015;
        }
        
        .predictions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .prediction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f2f2f7;
        }
        
        .prediction:last-child {
            border-bottom: none;
        }
        
        .prediction-time {
            font-weight: 500;
            font-family: -apple-system-monospaced, monospace;
        }
        
        .prediction-arrival {
            color: #8e8e93;
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            color: #8e8e93;
            padding: 20px;
        }
        
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8e8e93;
        }
        
        .empty-state h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1c1c1e;
            margin-bottom: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 200;
        }
        
        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #8e8e93;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
        }
        
        .inactive-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>NextTrain</h1>
    </div>
    
    <div class="container">
        <div class="controls">
            <button class="btn" onclick="refreshPredictions()">
                <span id="refreshText">Refresh</span>
            </button>
            <button class="btn btn-secondary" onclick="showAddModal()">
                Add Favorite
            </button>
        </div>
        
        <div id="errorContainer"></div>
        
        <div id="favoritesContainer" class="favorites-list">
            <div class="empty-state">
                <h2>No Favorites Yet</h2>
                <p>Add your favorite transit stops to see real-time departures</p>
            </div>
        </div>
    </div>
    
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Favorite Stop</h2>
                <button class="close-btn" onclick="hideAddModal()">&times;</button>
            </div>
            
            <form id="addFavoriteForm">
                <div class="form-group">
                    <label for="agency">Agency</label>
                    <select id="agency" required onchange="onAgencyChange()">
                        <option value="">Select agency...</option>
                    </select>
                </div>
                
                <div id="agencySpecificFields" style="display: none;">
                    <div class="form-group" id="routeGroup" style="display: none;">
                        <label for="route">Route</label>
                        <select id="route" required disabled onchange="onRouteChange()">
                            <option value="">Select agency first...</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="stopGroup" style="display: none;">
                        <label for="stop">Stop</label>
                        <select id="stop" required disabled onchange="onStopChange()">
                            <option value="">Select route first...</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="bartStationGroup" style="display: none;">
                        <label for="bartStation">Station</label>
                        <select id="bartStation" disabled onchange="onBartStationChange()">
                            <option value="">Loading stations...</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="bartLinesSelectGroup" style="display: none;">
                        <label>Lines (select one or more)</label>
                        <div id="bartLinesContainer" style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 8px;">
                            <span style="color: #8e8e93;">Select a station first...</span>
                        </div>
                    </div>
                    
                    <div class="form-group" id="directionGroup">
                        <label for="direction">Direction</label>
                        <select id="direction" required disabled>
                            <option value="">Select stop first...</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">
                        Add Favorite
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // State management
        let favorites = [];
        let isRefreshing = false;
        
        // Load favorites from localStorage
        function loadFavorites() {
            const stored = localStorage.getItem('nextTrainFavorites');
            if (stored) {
                favorites = JSON.parse(stored);
                // Ensure all favorites have active property defaulted to true
                favorites = favorites.map(f => ({
                    ...f,
                    active: f.active !== undefined ? f.active : true
                }));
            }
        }
        
        // Save favorites to localStorage
        function saveFavorites() {
            localStorage.setItem('nextTrainFavorites', JSON.stringify(favorites));
        }
        
        // Initialize app
        async function init() {
            loadFavorites();
            renderFavorites();
            if (favorites.length > 0) {
                await refreshPredictions();
            }
        }
        
        // Load agencies
        async function loadAgencies() {
            try {
                const response = await fetch('/api/transit/agencies');
                const data = await response.json();
                
                if (data.success) {
                    return data.agencies;
                } else {
                    throw new Error('Failed to load agencies');
                }
            } catch (error) {
                console.error('Failed to load agencies:', error);
                return null;
            }
        }
        
        // Load routes for an agency
        async function loadRoutes(agency) {
            try {
                const response = await fetch(`/api/transit/routes?agency=${agency}`);
                const data = await response.json();
                
                if (data.success) {
                    return data.routes;
                } else {
                    throw new Error('Failed to load routes');
                }
            } catch (error) {
                console.error('Failed to load routes:', error);
                return null;
            }
        }
        
        // Load stops for a route
        async function loadStops(agency, route) {
            try {
                const response = await fetch(`/api/transit/stops?agency=${agency}&route=${encodeURIComponent(route)}`);
                const data = await response.json();
                
                if (data.success) {
                    return data.stops;
                } else {
                    throw new Error('Failed to load stops');
                }
            } catch (error) {
                console.error('Failed to load stops:', error);
                return null;
            }
        }
        
        // Load directions for a stop
        async function loadDirections(agency, route, stop) {
            try {
                const response = await fetch(`/api/transit/stop-directions?agency=${agency}&route=${encodeURIComponent(route)}&stop=${stop}`);
                const data = await response.json();
                
                if (data.success) {
                    return data.directions;
                } else {
                    throw new Error('Failed to load directions');
                }
            } catch (error) {
                console.error('Failed to load directions:', error);
                return null;
            }
        }
        
        // Load BART stations
        async function loadBartStations() {
            try {
                const response = await fetch('/api/transit/bart/stations');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('bartStation');
                    select.innerHTML = '<option value="">Select station...</option>';
                    
                    data.stations.forEach(station => {
                        const option = document.createElement('option');
                        option.value = station.code;
                        option.textContent = station.name;
                        select.appendChild(option);
                    });
                    
                    // Enable the select after loading stations
                    select.disabled = false;
                    
                    return data.stations;
                } else {
                    throw new Error('Failed to load BART stations');
                }
            } catch (error) {
                console.error('Failed to load BART stations:', error);
                const select = document.getElementById('bartStation');
                select.innerHTML = '<option value="">Failed to load stations</option>';
                // Enable the select even on error so user can see the message
                select.disabled = false;
                return null;
            }
        }
        
        // Load BART lines for a station
        async function loadBartStationLines(stationCode) {
            try {
                const response = await fetch(`/api/transit/bart/station-lines?station=${stationCode}`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('bartLinesContainer');
                    
                    if (data.lines.length === 0) {
                        container.innerHTML = '<span style="color: #8e8e93;">No lines available for this station</span>';
                        return;
                    }
                    
                    container.innerHTML = data.lines.map(line => `
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="bartLines" value="${line.color}" style="margin-right: 8px;">
                            <span style="display: inline-block; width: 12px; height: 12px; background-color: ${line.hexcolor}; border-radius: 2px; margin-right: 6px;"></span>
                            ${line.name}
                        </label>
                    `).join('');
                } else {
                    throw new Error('Failed to load station lines');
                }
            } catch (error) {
                console.error('Failed to load BART station lines:', error);
                const container = document.getElementById('bartLinesContainer');
                container.innerHTML = '<span style="color: #ff3b30;">Failed to load available lines</span>';
            }
        }
        
        // Handle BART station selection
        async function onBartStationChange() {
            const stationCode = document.getElementById('bartStation').value;
            const container = document.getElementById('bartLinesContainer');
            
            if (!stationCode) {
                container.innerHTML = '<span style="color: #8e8e93;">Select a station first...</span>';
                return;
            }
            
            // Show loading state
            container.innerHTML = '<span style="color: #8e8e93;">Loading available lines...</span>';
            
            // Load available lines for this station
            await loadBartStationLines(stationCode);
        }
        
        // Populate agency dropdown
        function populateAgencySelect() {
            const select = document.getElementById('agency');
            select.innerHTML = '<option value="">Select agency...</option>';
            
            metadata.agencies.forEach(agency => {
                const option = document.createElement('option');
                option.value = agency.code;
                option.textContent = agency.name;
                if (!agency.active) {
                    option.textContent += ' (Inactive)';
                }
                select.appendChild(option);
            });
        }
        
        // Handle agency selection
        async function onAgencyChange() {
            const agencyCode = document.getElementById('agency').value;
            const routeSelect = document.getElementById('route');
            const stopSelect = document.getElementById('stop');
            const directionSelect = document.getElementById('direction');
            const agencySpecificFields = document.getElementById('agencySpecificFields');
            
            if (!agencyCode) {
                // Hide all fields if no agency selected
                agencySpecificFields.style.display = 'none';
                return;
            }
            
            // Show the agency-specific fields
            agencySpecificFields.style.display = 'block';
            
            // Show/hide appropriate fields based on agency
            const isBart = agencyCode === 'bart';
            document.getElementById('routeGroup').style.display = isBart ? 'none' : 'block';
            document.getElementById('stopGroup').style.display = isBart ? 'none' : 'block';
            document.getElementById('bartStationGroup').style.display = isBart ? 'block' : 'none';
            document.getElementById('bartLinesSelectGroup').style.display = isBart ? 'block' : 'none';
            
            // Reset downstream selections
            routeSelect.innerHTML = '<option value="">Loading routes...</option>';
            stopSelect.innerHTML = '<option value="">Select route first...</option>';
            directionSelect.innerHTML = '<option value="">Select stop first...</option>';
            routeSelect.disabled = true;
            stopSelect.disabled = true;
            directionSelect.disabled = true;
            
            // Make fields required/not required based on agency
            routeSelect.required = !isBart;
            stopSelect.required = !isBart;
            document.getElementById('bartStation').required = isBart;
            
            if (isBart) {
                // Load BART stations
                await loadBartStations();
                // Enable direction select for BART
                directionSelect.innerHTML = '<option value="">Select direction...</option><option value="n">Northbound</option><option value="s">Southbound</option>';
                directionSelect.disabled = false;
            } else {
                // Load routes for AC Transit
                const routes = await loadRoutes(agencyCode);
                
                if (!routes) {
                    routeSelect.innerHTML = '<option value="">Failed to load routes</option>';
                    return;
                }
                
                // Populate routes
                routeSelect.innerHTML = '<option value="">Select route...</option>';
                routes.forEach(route => {
                    const option = document.createElement('option');
                    option.value = route.routeCode;
                    option.textContent = route.routeCode;
                    if (route.routeName && route.routeName !== route.routeCode) {
                        option.textContent += ` - ${route.routeName}`;
                    }
                    routeSelect.appendChild(option);
                });
                routeSelect.disabled = false;
            }
        }
        
        // Handle route selection
        async function onRouteChange() {
            const agencyCode = document.getElementById('agency').value;
            const routeCode = document.getElementById('route').value;
            const stopSelect = document.getElementById('stop');
            const directionSelect = document.getElementById('direction');
            
            // Reset downstream selections
            stopSelect.innerHTML = '<option value="">Loading stops...</option>';
            directionSelect.innerHTML = '<option value="">Select stop first...</option>';
            stopSelect.disabled = true;
            directionSelect.disabled = true;
            
            if (!routeCode) {
                stopSelect.innerHTML = '<option value="">Select stop...</option>';
                return;
            }
            
            // Load stops for this route
            const stops = await loadStops(agencyCode, routeCode);
            
            if (!stops) {
                stopSelect.innerHTML = '<option value="">Failed to load stops</option>';
                return;
            }
            
            // Populate stops
            stopSelect.innerHTML = '<option value="">Select stop...</option>';
            stops.forEach(stop => {
                const option = document.createElement('option');
                option.value = stop.stopCode;
                option.textContent = stop.stopName;
                stopSelect.appendChild(option);
            });
            stopSelect.disabled = false;
        }
        
        // Handle stop selection
        async function onStopChange() {
            const agencyCode = document.getElementById('agency').value;
            const routeCode = document.getElementById('route').value;
            const stopCode = document.getElementById('stop').value;
            const directionSelect = document.getElementById('direction');
            
            // Reset direction selection
            directionSelect.innerHTML = '<option value="">Loading directions...</option>';
            directionSelect.disabled = true;
            
            if (!stopCode) {
                directionSelect.innerHTML = '<option value="">Select direction...</option>';
                return;
            }
            
            // Load directions for this stop
            const directions = await loadDirections(agencyCode, routeCode, stopCode);
            
            if (!directions) {
                directionSelect.innerHTML = '<option value="">Failed to load directions</option>';
                return;
            }
            
            // Populate directions
            directionSelect.innerHTML = '<option value="">Select direction...</option>';
            directions.forEach(direction => {
                const option = document.createElement('option');
                // Use destination as the value since that's what predictions return
                option.value = direction.destination;
                option.textContent = `${direction.direction} - ${direction.destination}`;
                // Store the specific stop ID for this direction
                option.dataset.stopId = direction.stopId;
                directionSelect.appendChild(option);
            });
            directionSelect.disabled = false;
        }
        
        // Show add favorite modal
        async function showAddModal() {
            // Show modal first
            document.getElementById('addModal').style.display = 'block';
            
            // Reset form
            document.getElementById('addFavoriteForm').reset();
            const selects = document.querySelectorAll('#addFavoriteForm select');
            const submitBtn = document.querySelector('#addFavoriteForm button[type="submit"]');
            
            // Disable all except agency
            selects.forEach((select, index) => {
                select.disabled = index > 0; // Only agency (index 0) is enabled
                if (index > 0) {
                    select.innerHTML = `<option value="">Select ${select.id} first...</option>`;
                }
            });
            
            // Load agencies
            const agencySelect = document.getElementById('agency');
            agencySelect.innerHTML = '<option value="">Loading agencies...</option>';
            agencySelect.disabled = true;
            
            const agencies = await loadAgencies();
            
            if (!agencies) {
                alert('Failed to load transit agencies. Please try again.');
                hideAddModal();
                return;
            }
            
            // Populate agencies
            agencySelect.innerHTML = '<option value="">Select agency...</option>';
            agencies.forEach(agency => {
                const option = document.createElement('option');
                option.value = agency.code;
                option.textContent = agency.name;
                agencySelect.appendChild(option);
            });
            agencySelect.disabled = false;
        }
        
        // Hide add favorite modal
        function hideAddModal() {
            document.getElementById('addModal').style.display = 'none';
            document.getElementById('addFavoriteForm').reset();
            
            // Reset selects
            document.getElementById('route').disabled = true;
            document.getElementById('stop').disabled = true;
            document.getElementById('direction').disabled = true;
            
            // Hide all agency-specific fields
            document.getElementById('agencySpecificFields').style.display = 'none';
            
            // Reset field visibility for next time
            document.getElementById('bartStationGroup').style.display = 'none';
            document.getElementById('bartLinesSelectGroup').style.display = 'none';
            document.getElementById('routeGroup').style.display = 'none';
            document.getElementById('stopGroup').style.display = 'none';
        }
        
        // Handle form submission
        document.getElementById('addFavoriteForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const agencyCode = document.getElementById('agency').value;
            const isBart = agencyCode === 'bart';
            
            let favorite;
            
            if (isBart) {
                // Handle BART submission
                const bartStation = document.getElementById('bartStation');
                const bartLinesCheckboxes = document.querySelectorAll('input[name="bartLines"]:checked');
                const selectedLines = Array.from(bartLinesCheckboxes).map(cb => cb.value);
                
                if (!bartStation.value || selectedLines.length === 0) {
                    alert('Please select a station and at least one line.');
                    return;
                }
                
                favorite = {
                    id: Date.now().toString(),
                    agency: agencyCode,
                    route: selectedLines.join(','), // Comma-separated lines
                    stop: bartStation.value,
                    direction: document.getElementById('direction').value,
                    predictions: [],
                    active: true
                };
                
                // Get display names
                const selectedStationOption = bartStation.options[bartStation.selectedIndex];
                favorite.agencyName = 'BART';
                favorite.stopName = selectedStationOption.textContent;
                
            } else {
                // Handle AC Transit submission
                const directionSelect = document.getElementById('direction');
                const selectedDirectionOption = directionSelect.options[directionSelect.selectedIndex];
                
                // Get the specific stop ID for the selected direction
                let stopId = document.getElementById('stop').value;
                if (selectedDirectionOption && selectedDirectionOption.dataset.stopId) {
                    stopId = selectedDirectionOption.dataset.stopId;
                }
                
                favorite = {
                    id: Date.now().toString(),
                    agency: agencyCode,
                    route: document.getElementById('route').value,
                    stop: stopId, // Use the direction-specific stop ID
                    direction: document.getElementById('direction').value,
                    predictions: [],
                    active: true
                };
                
                // Get display names from the select elements
                const agencySelect = document.getElementById('agency');
                const stopSelect = document.getElementById('stop');
                
                const selectedAgencyOption = agencySelect.options[agencySelect.selectedIndex];
                const selectedStopOption = stopSelect.options[stopSelect.selectedIndex];
                
                if (!selectedAgencyOption || !selectedStopOption || !selectedAgencyOption.value || !selectedStopOption.value) {
                    alert('Please select all fields.');
                    return;
                }
                
                favorite.agencyName = selectedAgencyOption.textContent;
                favorite.stopName = selectedStopOption.textContent;
            }
            
            // Validate direction for BART
            if (isBart && !favorite.direction) {
                alert('Please select a direction for BART.');
                return;
            }
            
            favorites.push(favorite);
            saveFavorites();
            hideAddModal();
            renderFavorites();
            
            // Small delay to ensure DOM is ready before fetching predictions
            setTimeout(() => {
                refreshPredictions();
            }, 100);
        });
        
        // Remove favorite
        function removeFavorite(id) {
            favorites = favorites.filter(f => f.id !== id);
            saveFavorites();
            renderFavorites();
        }
        
        // Render favorites list
        function renderFavorites(preservePredictions = false) {
            const container = document.getElementById('favoritesContainer');
            
            // Save current predictions if requested
            const savedPredictions = {};
            if (preservePredictions) {
                favorites.forEach(favorite => {
                    const predictionsDiv = document.getElementById(`predictions-${favorite.id}`);
                    if (predictionsDiv) {
                        savedPredictions[favorite.id] = predictionsDiv.innerHTML;
                    }
                });
            }
            
            if (favorites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No Favorites Yet</h2>
                        <p>Add your favorite transit stops to see real-time departures</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = favorites.map(favorite => `
                <div class="favorite-card">
                    ${favorite.active === false ? '<div class="inactive-warning">This stop or route may no longer be in service</div>' : ''}
                    <div class="favorite-header">
                        <div class="favorite-info">
                            <h3>
                                <img src="/images/${favorite.agency}.png" alt="${favorite.agencyName}" class="agency-icon">
                                ${favorite.stopName}
                            </h3>
                            <p>${
                                favorite.agency === 'bart' 
                                    ? favorite.route.split(',').map(line => line.charAt(0).toUpperCase() + line.slice(1)).join('/') + ' Line' + (favorite.route.includes(',') ? 's' : '')
                                    : favorite.route
                            } • ${
                                favorite.agency === 'bart' && favorite.direction 
                                    ? (favorite.direction === 'n' ? 'Northbound' : 'Southbound')
                                    : favorite.direction
                            }</p>
                        </div>
                        <button class="remove-btn" onclick="removeFavorite('${favorite.id}')">
                            Remove
                        </button>
                    </div>
                    <div class="predictions" id="predictions-${favorite.id}">
                        ${savedPredictions[favorite.id] || '<div class="loading">Loading predictions...</div>'}
                    </div>
                </div>
            `).join('');
        }
        
        // Format time
        function formatTime(isoTime) {
            const date = new Date(isoTime);
            const now = new Date();
            const minutes = Math.round((date - now) / 60000);
            
            
            if (minutes < 1) return 'Now';
            if (minutes === 1) return '1 min';
            return `${minutes} mins`;
        }
        
        // Format arrival time
        function formatArrivalTime(isoTime) {
            const date = new Date(isoTime);
            // This will automatically convert UTC to local time
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true,
                timeZone: 'America/Los_Angeles' // Force Pacific Time
            });
        }
        
        // Refresh predictions for all favorites
        async function refreshPredictions() {
            if (isRefreshing) return;
            
            isRefreshing = true;
            const refreshBtn = document.querySelector('.btn');
            refreshBtn.disabled = true;
            document.getElementById('refreshText').textContent = 'Refreshing...';
            
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = '';
            
            try {
                await Promise.all(favorites.map(async (favorite) => {
                    const predictionsDiv = document.getElementById(`predictions-${favorite.id}`);
                    
                    try {
                        let url = `/api/transit/predictions?agency=${favorite.agency}&stop=${favorite.stop}&route=${favorite.route}`;
                        
                        // Add direction parameter for BART (required)
                        if (favorite.agency === 'bart' && favorite.direction) {
                            url += `&direction=${favorite.direction}`;
                        }
                        
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        // Determine if the stop/route is active based on server response
                        if (data.success && data.predictions.length > 0) {
                            // Mark as active - predictions available
                            favorite.active = true;
                            
                            // Filter by direction if specified (only for AC Transit)
                            // BART already filters by direction on the server
                            let predictions = data.predictions;
                            if (favorite.direction && favorite.agency !== 'bart') {
                                predictions = predictions.filter(p => 
                                    p.direction.includes(favorite.direction)
                                );
                            }
                            
                            // Take top 3 predictions
                            predictions = predictions.slice(0, 3);
                            
                            if (predictions.length === 0) {
                                // No predictions after filtering - mark as potentially inactive
                                favorite.active = false;
                                predictionsDiv.innerHTML = '<p style="color: #8e8e93;">No upcoming departures</p>';
                            } else {
                                predictionsDiv.innerHTML = predictions.map(pred => `
                                    <div class="prediction">
                                        <span class="prediction-time">${formatTime(pred.departureTime)}</span>
                                        <span class="prediction-arrival">${formatArrivalTime(pred.departureTime)}</span>
                                    </div>
                                `).join('');
                            }
                        } else {
                            // No predictions from server - mark as inactive
                            favorite.active = false;
                            predictionsDiv.innerHTML = '<p style="color: #8e8e93;">No predictions available</p>';
                        }
                    } catch (error) {
                        // Error fetching - mark as inactive
                        favorite.active = false;
                        predictionsDiv.innerHTML = '<p style="color: #ff3b30;">Failed to load</p>';
                        console.error(`Failed to fetch predictions for ${favorite.id}:`, error);
                    }
                }));
            } catch (error) {
                errorContainer.innerHTML = `
                    <div class="error">
                        Failed to refresh predictions. Please try again.
                    </div>
                `;
            } finally {
                isRefreshing = false;
                refreshBtn.disabled = false;
                document.getElementById('refreshText').textContent = 'Refresh';
                // Update active status warnings without re-rendering entire favorites
                favorites.forEach(favorite => {
                    const card = document.querySelector(`#predictions-${favorite.id}`).closest('.favorite-card');
                    const warning = card.querySelector('.inactive-warning');
                    if (favorite.active === false && !warning) {
                        // Add warning if newly inactive
                        card.insertAdjacentHTML('afterbegin', '<div class="inactive-warning">This stop or route may no longer be in service</div>');
                    } else if (favorite.active !== false && warning) {
                        // Remove warning if now active
                        warning.remove();
                    }
                });
            }
        }
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (favorites.length > 0 && !isRefreshing) {
                refreshPredictions();
            }
        }, 30000);
        
        // Initialize on load
        init();
    </script>
    
    <footer style="margin-top: 60px; padding: 20px; text-align: center; font-size: 14px; color: #8e8e93;">
        <a href="/support" style="color: #007AFF; text-decoration: none; margin: 0 10px;">Support</a>
        •
        <a href="/privacy" style="color: #007AFF; text-decoration: none; margin: 0 10px;">Privacy</a>
    </footer>
</body>
</html>
